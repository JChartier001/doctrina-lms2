#!/bin/bash

# Pre-commit hook for standards audit
# Runs incremental audit on staged files only

set -e

echo "ğŸ” Running standards audit on staged files..."

# Get staged TypeScript files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' || true)

if [ -z "$STAGED_FILES" ]; then
  echo "âœ… No TypeScript files to audit"
  exit 0
fi

echo "Found $(echo "$STAGED_FILES" | wc -l) TypeScript file(s) to audit"

# Create temporary file list
TEMP_FILE=$(mktemp)
echo "$STAGED_FILES" > "$TEMP_FILE"

# Run incremental audit on staged files only
# This will be implemented by Stream A - for now, just validate TypeScript compilation
echo "Validating TypeScript compilation..."

HAS_ERRORS=false
for FILE in $STAGED_FILES; do
  if [ -f "$FILE" ]; then
    # Check TypeScript compilation for this file
    if ! bun run tsc --noEmit "$FILE" 2>/dev/null; then
      echo "âŒ TypeScript error in: $FILE"
      HAS_ERRORS=true
    fi
  fi
done

# Clean up temp file
rm -f "$TEMP_FILE"

if [ "$HAS_ERRORS" = true ]; then
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "âŒ Standards audit failed!"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "Fix the violations above or use 'git commit --no-verify' to skip"
  echo ""
  exit 1
fi

echo "âœ… Standards audit passed!"
exit 0
