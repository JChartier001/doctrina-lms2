<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>110</epicId>
    <storyId>3</storyId>
    <title>Create Updated Seed Data for Manual Testing</title>
    <status>Draft</status>
    <generatedAt>2025-11-11</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/story-110.3.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>recreate comprehensive seed data that matches the updated schema</iWant>
    <soThat>I can manually test new features and verify system behavior with realistic data</soThat>
    <tasks>
      <task id="1">Create Seed Data Script Structure (AC8)</task>
      <task id="2">Seed Core User Data (AC1)</task>
      <task id="3">Seed Course Hierarchy (AC2)</task>
      <task id="4">Seed Enrollments &amp; Purchases (AC3)</task>
      <task id="5">Seed Progress Tracking (AC4)</task>
      <task id="6">Seed Certificates (AC5)</task>
      <task id="7">Seed Supporting Data (AC6)</task>
      <task id="8">Create Seed Execution Script (AC8)</task>
      <task id="9">Validation (All ACs)</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1">
      <title>Core User Data Created</title>
      <description>At least 3 test users with different roles (student, instructor, admin). All users have complete profile data (firstName, lastName, email, externalId). Users properly indexed for Clerk integration.</description>
    </ac>
    <ac id="2">
      <title>Course Hierarchy Data Created</title>
      <description>At least 2 complete courses ("Advanced Botox Techniques", "Laser Fundamentals") with 2-3 modules each, 3-5 lessons per module (mixed types: video, quiz, assignment), proper ordering, realistic metadata.</description>
    </ac>
    <ac id="3">
      <title>Enrollment &amp; Purchase Data Created</title>
      <description>Student user enrolled in at least 1 course with corresponding complete purchase record. Enrollment linked to purchase via purchaseId. progressPercent set to realistic values (0%, 30%, 100%).</description>
    </ac>
    <ac id="4">
      <title>Progress Tracking Data Created</title>
      <description>lessonProgress records for enrolled student. Mix of completed and incomplete lessons with realistic completion timestamps. Proper indexing (by_user, by_lesson, by_user_lesson).</description>
    </ac>
    <ac id="5">
      <title>Certificate Data Created</title>
      <description>At least 1 certificate for completed course with valid unique verificationCode. All required fields populated. Certificate retrievable by user and verifiable.</description>
    </ac>
    <ac id="6">
      <title>Supporting Data Created</title>
      <description>Notifications (at least 3 per user, mixed types), Live sessions (1 scheduled, 1 completed), Resources (at least 5, mixed categories), Favorites (student has 2-3 favorited resources).</description>
    </ac>
    <ac id="7">
      <title>Edge Cases Included</title>
      <description>1 expired purchase (status: 'expired'), 1 open purchase (status: 'open'), 1 course with no enrollments, 1 course with isPreview lessons, test data for quiz system if schema supports it.</description>
    </ac>
    <ac id="8">
      <title>Seed Script Created</title>
      <description>Convex mutation function to seed all data. Idempotent (can be run multiple times safely). Clears existing test data before seeding. Returns summary of created records. Documented in code with clear comments.</description>
    </ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>convex/schema.ts</path>
        <title>Convex Database Schema</title>
        <section>Complete Schema Definition</section>
        <snippet>Defines all database tables including users, courses, courseModules, lessons, enrollments, purchases, lessonProgress, certificates, notifications, liveSessions, resources, favorites, quizzes, quizQuestions, quizAttempts, and courseReviews. Schema includes field types, indexes, and relationships between tables.</snippet>
      </doc>
      <doc>
        <path>docs/TESTING-STRATEGY.md</path>
        <title>Testing Strategy</title>
        <section>Testing Philosophy</section>
        <snippet>Priority-based testing approach: 100% coverage on financial/security code, 85% on core features, 70% on UI. Seed data should support manual testing workflows and be representative of production scenarios with edge cases for QA validation.</snippet>
      </doc>
      <doc>
        <path>docs/ARCHITECTURE.md</path>
        <title>Architecture Documentation</title>
        <section>Convex Backend - Function Types</section>
        <snippet>Convex uses three function types: Queries (read data, reactive), Mutations (write data, transactional), Actions (call external APIs). Mutations use ctx.db.insert() for creating records and must follow transactional patterns.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>convex/courses.ts</path>
        <kind>mutation</kind>
        <symbol>create</symbol>
        <lines>53-74</lines>
        <reason>Reference implementation for creating course records. Shows proper mutation structure, timestamp handling (Date.now()), and returning inserted ID. Pattern to follow for seedCourses helper.</reason>
      </artifact>
      <artifact>
        <path>convex/users.ts</path>
        <kind>mutation</kind>
        <symbol>create</symbol>
        <lines>33-53</lines>
        <reason>Reference implementation for creating user records with Clerk integration. Shows duplicate checking pattern (query by index first), externalId usage, and default field values. Pattern to follow for seedUsers helper.</reason>
      </artifact>
      <artifact>
        <path>convex/schema.ts</path>
        <kind>schema</kind>
        <symbol>userSchema</symbol>
        <lines>4-19</lines>
        <reason>User table schema definition. Required fields: firstName, lastName, email, externalId, isInstructor, isAdmin. Optional fields: image, profilePhotoUrl, bio, title, phone, lastLogin, createdAt, updatedAt.</reason>
      </artifact>
      <artifact>
        <path>convex/schema.ts</path>
        <kind>schema</kind>
        <symbol>courseSchema</symbol>
        <lines>21-36</lines>
        <reason>Course table schema. Required: title, description, instructorId (v.id('users')), createdAt, updatedAt (numbers). Optional: level, duration, price, thumbnailUrl, rating, reviewCount, tags, whatYouWillLearn, requirements.</reason>
      </artifact>
      <artifact>
        <path>convex/schema.ts</path>
        <kind>schema</kind>
        <symbol>courseModuleSchema</symbol>
        <lines>139-145</lines>
        <reason>Module schema. Required: courseId (v.id('courses')), title, order (number), createdAt. Optional: description. Indexed by course and by course+order.</reason>
      </artifact>
      <artifact>
        <path>convex/schema.ts</path>
        <kind>schema</kind>
        <symbol>lessonSchema</symbol>
        <lines>125-137</lines>
        <reason>Lesson schema. Required: moduleId (v.id('courseModules')), title, type (union: 'video'|'quiz'|'assignment'), isPreview (boolean), order. Optional: description, duration, videoUrl, videoId, content. Indexed by module and by module+order.</reason>
      </artifact>
      <artifact>
        <path>convex/schema.ts</path>
        <kind>schema</kind>
        <symbol>purchaseSchema</symbol>
        <lines>115-123</lines>
        <reason>Purchase schema. Required: userId (v.id('users')), courseId (v.id('courses')), amount (number), status (union: 'open'|'complete'|'expired'), createdAt (number). Optional: stripeSessionId, currency.</reason>
      </artifact>
      <artifact>
        <path>convex/schema.ts</path>
        <kind>schema</kind>
        <symbol>enrollmentSchema</symbol>
        <lines>147-154</lines>
        <reason>Enrollment schema. Required: userId (v.id('users')), courseId (v.id('courses')), purchaseId (v.id('purchases')), enrolledAt (number), progressPercent (number 0-100). Optional: completedAt. Indexed by user, course, and user+course.</reason>
      </artifact>
      <artifact>
        <path>convex/schema.ts</path>
        <kind>schema</kind>
        <symbol>lessonProgressSchema</symbol>
        <lines>155-159</lines>
        <reason>Lesson progress schema. Required: userId (v.id('users')), lessonId (v.id('lessons')), completedAt (number). Indexed by user, lesson, and user+lesson for efficient querying.</reason>
      </artifact>
      <artifact>
        <path>convex/schema.ts</path>
        <kind>schema</kind>
        <symbol>certificateSchema</symbol>
        <lines>103-114</lines>
        <reason>Certificate schema. Required: userId, userName, courseId, courseName, instructorId, instructorName, issueDate (string), verificationCode (string - unique), templateId. Optional: expiryDate. Indexed by user and by verificationCode.</reason>
      </artifact>
      <artifact>
        <path>convex/schema.ts</path>
        <kind>schema</kind>
        <symbol>notificationSchema</symbol>
        <lines>66-83</lines>
        <reason>Notification schema. Required: userId, title, description, type (union of 7 types including 'course_update', 'certificate', 'milestone'), read (boolean), createdAt. Optional: link, metadata. Indexed by userId+createdAt.</reason>
      </artifact>
      <artifact>
        <path>convex/schema.ts</path>
        <kind>schema</kind>
        <symbol>liveSessionSchema</symbol>
        <lines>85-95</lines>
        <reason>Live session schema. Required: title, description, instructorId, scheduledFor (number), duration (number), isRecorded (boolean), maxParticipants (number), status (union: 'scheduled'|'live'|'completed'|'cancelled'). Optional: recordingUrl.</reason>
      </artifact>
      <artifact>
        <path>convex/schema.ts</path>
        <kind>schema</kind>
        <symbol>resourceSchema</symbol>
        <lines>44-64</lines>
        <reason>Resource schema. Required: title, description, type, categories (array), tags (array), url, author, dateAdded (string), featured (boolean), downloadCount, favoriteCount, rating, reviewCount, difficulty (union), restricted (boolean). Optional: thumbnailUrl, duration, fileSize, courseId.</reason>
      </artifact>
      <artifact>
        <path>convex/schema.ts</path>
        <kind>schema</kind>
        <symbol>favoritesSchema</symbol>
        <lines>38-42</lines>
        <reason>Favorites schema. Required: userId (v.id('users')), resourceId (v.id('resources')), createdAt (number). Indexed by user+resource and by resource.</reason>
      </artifact>
      <artifact>
        <path>convex/__test__/courses.test.ts</path>
        <kind>test</kind>
        <symbol>beforeEach setup</symbol>
        <lines>17-58</lines>
        <reason>Example of test data creation pattern using ctx.db.insert(). Shows realistic test data structure with instructor user, course creation, and proper field values. Useful reference for seed data realistic values.</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="convex" version="^1.28.2" />
        <package name="next" version="16.0.1" />
        <package name="@clerk/backend" version="^2.20.0" />
        <package name="@clerk/nextjs" version="^6.34.5" />
        <package name="vitest" version="4.0.8" />
        <package name="convex-test" version="^0.0.38" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint id="1">
      <title>Idempotency Required</title>
      <description>Seed script must be idempotent - can run multiple times without duplicating data. Detect existing test data via "test-*" externalId pattern and clear before seeding.</description>
    </constraint>
    <constraint id="2">
      <title>Test Data Identification Pattern</title>
      <description>All test users must use externalId prefix "test-" (e.g., "test-student-clerk-id", "test-instructor-clerk-id", "test-admin-clerk-id") to enable easy identification and cleanup.</description>
    </constraint>
    <constraint id="3">
      <title>Convex Mutation Pattern</title>
      <description>Follow established Convex mutation patterns: use mutation() wrapper, define args with v.* validators, use async handler with ctx parameter, use ctx.db.insert() for creating records, return inserted IDs.</description>
    </constraint>
    <constraint id="4">
      <title>Data Relationships Must Be Valid</title>
      <description>Maintain referential integrity: User (instructor) → Course → CourseModule → Lesson; User (student) + Course → Purchase → Enrollment; Enrollment + Lesson → LessonProgress; Completed Enrollment → Certificate.</description>
    </constraint>
    <constraint id="5">
      <title>Realistic Test Data</title>
      <description>Per TESTING-STRATEGY.md, seed data should mirror production scenarios for effective manual testing. Include realistic course titles ("Advanced Botox Techniques", "Laser Fundamentals"), realistic prices ($299, $199), proper timestamps, and edge cases.</description>
    </constraint>
    <constraint id="6">
      <title>TypeScript Compilation Required</title>
      <description>All seed functions must compile without TypeScript errors. Use proper typing from schema definitions (v.id('tableName') for IDs, proper unions for status fields).</description>
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>ctx.db.insert</name>
      <kind>Convex Database API</kind>
      <signature>ctx.db.insert(tableName: string, document: object): Promise&lt;Id&lt;TableName&gt;&gt;</signature>
      <path>convex/_generated/server</path>
      <usage>Primary method for inserting records into Convex tables. Returns the ID of newly created record.</usage>
    </interface>
    <interface>
      <name>ctx.db.query</name>
      <kind>Convex Database API</kind>
      <signature>ctx.db.query(tableName: string): QueryInitializer</signature>
      <path>convex/_generated/server</path>
      <usage>Used for querying records, supports chaining .withIndex(), .filter(), .collect(). Needed for idempotency checks to detect existing test data.</usage>
    </interface>
    <interface>
      <name>ctx.db.delete</name>
      <kind>Convex Database API</kind>
      <signature>ctx.db.delete(id: Id&lt;TableName&gt;): Promise&lt;void&gt;</signature>
      <path>convex/_generated/server</path>
      <usage>Delete records by ID. Used in clearExistingTestData() helper to remove existing test records before reseeding.</usage>
    </interface>
    <interface>
      <name>mutation</name>
      <kind>Convex Function Wrapper</kind>
      <signature>mutation({ args: { ... }, handler: async (ctx, args) =&gt; { ... } })</signature>
      <path>convex/_generated/server</path>
      <usage>Wrapper for all Convex mutations. Takes args object with validators and async handler function.</usage>
    </interface>
    <interface>
      <name>v.id</name>
      <kind>Convex Validator</kind>
      <signature>v.id(tableName: string)</signature>
      <path>convex/values</path>
      <usage>Validator for Convex ID references. Use for all foreign key relationships (e.g., v.id('users'), v.id('courses')).</usage>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing framework: Vitest with convex-test library for Convex function testing. Seed data should enable manual testing workflows in browser. No automated tests required for seed scripts themselves, but seed data must support testing all implemented features. Validation: run seed script, verify records created via Convex dashboard queries, test manual user flows in application.
    </standards>
    <locations>
      <location>convex/seedData.ts - Main seed mutation file (to be created)</location>
      <location>convex/seedCurrentUser.ts - User-friendly seed wrapper (to be created)</location>
      <location>convex/__test__/*.test.ts - Existing test files show test data creation patterns</location>
    </locations>
    <ideas>
      <idea ac="8">Test idempotency: run seedTestData mutation twice, verify same number of records created (not duplicated)</idea>
      <idea ac="1">Test user creation: query users table for "test-student-clerk-id", verify firstName, lastName, email, isInstructor=false</idea>
      <idea ac="2">Test course hierarchy: query courses by instructor, verify 2 courses, query modules by course, verify 2-3 per course, query lessons by module, verify 3-5 per module with proper types</idea>
      <idea ac="3">Test enrollment-purchase link: query enrollments for test student, verify purchaseId exists and links to valid purchase with status='complete'</idea>
      <idea ac="4">Test progress tracking: query lessonProgress for test student, verify 30% of lessons marked complete with realistic timestamps</idea>
      <idea ac="5">Test certificate: query certificates for test student, verify verificationCode is unique 16-char format (XXXX-XXXX-XXXX-XXXX)</idea>
      <idea ac="6">Test supporting data: query notifications, liveSessions, resources, favorites - verify counts and types match acceptance criteria</idea>
      <idea ac="7">Test edge cases: query purchases with status='expired' and status='open', verify existence; query courses with no enrollments, verify at least one exists</idea>
      <idea ac="all">Manual browser testing: login as test-student, view enrolled courses, see progress bars at 30%, view certificates, check notifications</idea>
    </ideas>
  </tests>
</story-context>
