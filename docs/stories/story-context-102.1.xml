<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>102</epicId>
    <storyId>1</storyId>
    <title>Implement Quiz Creation and Retrieval Backend</title>
    <status>Draft</status>
    <generatedAt>2025-11-07</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/story-102.1.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>instructor</asA>
    <iWant>create quizzes with multiple-choice questions for my courses</iWant>
    <soThat>I can assess student knowledge and provide structured learning assessments</soThat>
    <tasks>
      <task id="1" ac="AC1,AC2">Create convex/quizzes.ts File
        <subtask id="1.1">Implement create() mutation</subtask>
        <subtask id="1.2">Implement addQuestions() mutation</subtask>
        <subtask id="1.3">Add comprehensive JSDoc comments</subtask>
      </task>
      <task id="2" ac="AC3,AC4">Implement Query Functions
        <subtask id="2.1">Implement getQuiz() query</subtask>
        <subtask id="2.2">Implement getModuleQuizzes() query</subtask>
      </task>
      <task id="3" ac="AC5">Authorization and Security
        <subtask id="3.1">Implement instructor ownership verification</subtask>
        <subtask id="3.2">Security review</subtask>
      </task>
      <task id="4" ac="AC6,AC7">Testing
        <subtask id="4.1">Unit tests for create() mutation</subtask>
        <subtask id="4.2">Unit tests for addQuestions() mutation</subtask>
        <subtask id="4.3">Unit tests for getQuiz() query</subtask>
        <subtask id="4.4">Unit tests for getModuleQuizzes() query</subtask>
        <subtask id="4.5">Integration tests</subtask>
        <subtask id="4.6">Code quality checks</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">Instructor can create quiz for their course
      - quizzes.create() mutation implemented
      - Verifies user is course instructor
      - Creates quiz record with title, passing score, course/module IDs
      - Returns quiz ID</criterion>
    <criterion id="AC2">Instructor can add questions to quiz
      - quizzes.addQuestions() mutation implemented
      - Bulk inserts multiple questions
      - Preserves question order
      - Validates ownership (instructor owns course)</criterion>
    <criterion id="AC3">Student can retrieve quiz without correct answers
      - quizzes.getQuiz() query implemented
      - Returns quiz with questions array
      - Security: Excludes correctAnswer field from response
      - Questions sorted by order</criterion>
    <criterion id="AC4">Get module quizzes query implemented
      - quizzes.getModuleQuizzes() query returns all quizzes for a module
      - Used for module-level quiz listing
      - Returns array of quiz objects</criterion>
    <criterion id="AC5">Authorization enforced
      - Only course instructor can create quizzes
      - Only course instructor can add questions
      - Throws "Not authorized" error for non-instructors</criterion>
    <criterion id="AC6">All tests pass
      - Unit tests for create, addQuestions, getQuiz
      - Security tests verify no correct answers leaked
      - Authorization tests verify instructor-only access
      - 100% test pass rate</criterion>
    <criterion id="AC7">TypeScript types and code quality
      - Proper Convex types used
      - No TypeScript errors
      - Code follows project patterns
      - Lint passes</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/tech-spec-epic-102.md"
           title="Technical Specification: Quiz Submission & Grading System"
           section="APIs and Interfaces">
        Complete API specifications for quiz system (lines 136-260). Defines request/response formats for create, addQuestions, getQuiz, submit, getBestAttempt mutations and queries. Security requirements: correctAnswer must never be exposed to students before submission. Grading happens server-side only.
      </doc>
      <doc path="docs/PRD.md"
           title="Product Requirements Document"
           section="F5: Course Learning Interface">
        Quiz interface requirements (lines 726-730). Multiple choice questions, instant feedback, 80% passing score, unlimited retakes. Must integrate with learning page and course wizard.
      </doc>
      <doc path="docs/ARCHITECTURE.md"
           title="Technical Architecture"
           section="Convex Mutations Pattern">
        Mutation pattern examples (lines 203-220). Shows authentication checks, authorization validation, error handling patterns. All mutations must verify ctx.auth.getUserIdentity() and check permissions.
      </doc>
      <doc path="docs/TESTING-STRATEGY.md"
           title="Testing Strategy"
           section="Core Business Logic">
        Core features should have 85% test coverage (Priority 2). Quiz grading and authorization are core features requiring comprehensive testing. Use convex-test for mutation/query testing.
      </doc>
      <doc path="docs/tech-spec-epic-102.md"
           title="Technical Specification: Quiz Submission & Grading System"
           section="Workflows and Sequencing">
        Instructor Creates Quiz Flow (lines 266-294) and Student Takes Quiz Flow (lines 296-337). Complete workflow sequences showing authentication, authorization, data validation, and error handling at each step.
      </doc>
    </docs>

    <code>
      <artifact path="convex/schema.ts"
                kind="schema-definition"
                symbol="quizzes, quizQuestions, quizAttempts"
                lines="187-218"
                reason="Quiz table definitions already in schema. Three tables: quizzes (metadata), quizQuestions (4-option MCQ), quizAttempts (submissions). Indexes defined: by_course, by_module, by_quiz, by_user_quiz. No schema changes needed, use existing structure."/>
      <artifact path="convex/courses.ts"
                kind="convex-mutations"
                symbol="create, update"
                reason="Reference implementation for instructor ownership verification pattern. Shows how to load course, check instructorId matches authenticated user, throw 'Not authorized' error. Follow same pattern in quizzes.create()."/>
      <artifact path="convex/lessonProgress.ts"
                kind="convex-mutations"
                symbol="markComplete, recalculateProgress"
                reason="Reference implementation for authentication pattern. Shows ctx.auth.getUserIdentity() usage, error handling for null identity, Convex mutation structure. Follow same patterns in quiz mutations."/>
      <artifact path="components/course-wizard/ai-quiz-generator.tsx"
                kind="react-component"
                symbol="AIQuizGenerator"
                reason="Frontend UI component that will call quizzes.create() and addQuestions(). Check component to understand expected API contract and data format for questions array."/>
      <artifact path="convex/__test__/lessonProgress.test.ts"
                kind="unit-test"
                symbol="all tests"
                reason="Reference test structure using convex-test library. Shows how to set up test data, use convexTest(schema), test authentication/authorization, verify error handling. Follow same patterns for quiz tests."/>
    </code>

    <dependencies>
      <node>
        <package name="convex" version="^1.28.2">Convex serverless backend - provides mutation/query primitives</package>
        <package name="typescript" version="^5.9.3">TypeScript for type safety</package>
        <package name="vitest" version="4.0.8">Testing framework</package>
        <package name="convex-test" version="^0.0.38">Convex testing utilities for mocking ctx</package>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="security-critical">NEVER return correctAnswer field to students in getQuiz() query. This is the most critical security requirement. Correct answers only revealed AFTER quiz submission in grading results. Implement explicit field exclusion in query mapping.</constraint>
    <constraint type="authorization">Only course instructor can create quizzes and add questions. Must verify course.instructorId matches authenticated user's identity. Throw "Not authorized" error for non-instructors. This prevents students from creating fake quizzes.</constraint>
    <constraint type="authentication">All mutations and queries must check ctx.auth.getUserIdentity() is non-null. Throw "Not authenticated" error if user not logged in. Follow pattern from lessonProgress.ts.</constraint>
    <constraint type="data-validation">Questions array must have exactly 4 options (enforced at application level). correctAnswer must be 0-3 (valid array index). passingScore must be 0-100. Validate these constraints in addQuestions mutation.</constraint>
    <constraint type="question-ordering">Questions must be inserted with order field starting at 0. When retrieving questions, ALWAYS sort by order field to maintain quiz structure. Order is critical for answer array alignment.</constraint>
    <constraint type="bulk-operations">addQuestions mutation must support bulk insertion (array of questions). Use for loop to insert each question with order index. Return array of created question IDs for frontend confirmation.</constraint>
    <constraint type="testing-coverage">85% test coverage target per TESTING-STRATEGY.md Priority 2. 100% coverage required on authorization logic and security-critical code (correctAnswer exclusion). Use convex-test library with convexTest(schema) pattern.</constraint>
  </constraints>

  <interfaces>
    <interface name="quizzes.create"
               kind="convex-mutation"
               signature="mutation({ args: { courseId: Id&lt;'courses'&gt;, moduleId?: Id&lt;'courseModules'&gt;, title: string, passingScore: number }, handler: async (ctx, args) => Id&lt;'quizzes'&gt; })"
               path="convex/quizzes.ts (CREATE)">
      Creates new quiz for course or module. Must verify user is course instructor. Args: courseId (required), moduleId (optional for course-wide quiz), title, passingScore (default 80). Returns quiz ID. Throws "Not authenticated" if no user, "Not authorized" if not instructor, "Course not found" if invalid courseId.
    </interface>
    <interface name="quizzes.addQuestions"
               kind="convex-mutation"
               signature="mutation({ args: { quizId: Id&lt;'quizzes'&gt;, questions: Array&lt;{ question: string, options: string[], correctAnswer: number, explanation?: string }&gt; }, handler: async (ctx, args) => Id&lt;'quizQuestions'&gt;[] })"
               path="convex/quizzes.ts (CREATE)">
      Bulk adds questions to quiz. Verifies instructor owns course. Each question: question text, 4 options array, correctAnswer index (0-3), optional explanation. Returns array of created question IDs. Preserves order via order field set to array index.
    </interface>
    <interface name="quizzes.getQuiz"
               kind="convex-query"
               signature="query({ args: { quizId: Id&lt;'quizzes'&gt; }, handler: async (ctx, { quizId }) => QuizWithQuestions | null })"
               path="convex/quizzes.ts (CREATE)">
      Returns quiz with questions for student. CRITICAL SECURITY: Must exclude correctAnswer field from questions array. Query questions via by_quiz index, sort by order, map to student-safe format. Response: { ...quiz, questions: [{ id, question, options }] }. No authentication required (public quiz data).
    </interface>
    <interface name="quizzes.getModuleQuizzes"
               kind="convex-query"
               signature="query({ args: { moduleId: Id&lt;'courseModules'&gt; }, handler: async (ctx, { moduleId }) => Quiz[] })"
               path="convex/quizzes.ts (CREATE)">
      Returns all quizzes for a module. Query via by_module index. Returns array of quiz objects (metadata only, no questions). Used for module quiz listing in learning interface.
    </interface>
  </interfaces>

  <tests>
    <standards>
      Use Vitest with convex-test library for Convex function testing. Create test file at convex/__test__/quizzes.test.ts. Use convexTest(schema) to initialize test environment. Target 85% coverage (Priority 2: Core Features). 100% coverage required on authorization and security-critical code (correctAnswer exclusion). Test pattern: describe() blocks for each function, it() for each test case, expect() assertions.
    </standards>
    <locations>
      <location>convex/__test__/quizzes.test.ts (create this file)</location>
      <location>convex/__test__/lessonProgress.test.ts (reference for test patterns)</location>
    </locations>
    <ideas>
      <idea ac="AC1">Unit test: Instructor creates quiz, verify quiz record inserted with all fields. Test error: non-instructor tries to create, verify "Not authorized" thrown.</idea>
      <idea ac="AC2">Unit test: Add 10 questions via addQuestions(), verify order preserved (0-9), all questions linked to quizId. Test error: non-owner tries to add questions.</idea>
      <idea ac="AC3">Unit test: Call getQuiz(), verify questions returned WITHOUT correctAnswer field. Map over response.questions, assert each has {id, question, options} but NO correctAnswer property.</idea>
      <idea ac="AC4">Unit test: Create 3 quizzes for same module, call getModuleQuizzes(), verify returns all 3. Test empty module returns empty array.</idea>
      <idea ac="AC5">Authorization test: Create course as instructor1, try to create quiz as instructor2, verify error. Test student cannot create quiz.</idea>
      <idea ac="AC6,AC7">Integration test: Full flow - create quiz → add questions → getQuiz → verify questions retrieved in order without answers. Run yarn typescript and yarn test to validate.</idea>
    </ideas>
  </tests>
</story-context>
