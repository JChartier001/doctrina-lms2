<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>101</epicId>
    <storyId>2</storyId>
    <title>Refactor Certificate Generation to Use Convex-Helpers Triggers</title>
    <status>Draft</status>
    <generatedAt>2025-11-03</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/story-101.2.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>refactor the certificate generation logic to use convex-helpers triggers pattern</iWant>
    <soThat>the code is more maintainable, follows separation of concerns, and enables future extensibility</soThat>
    <tasks>
      <task id="1" ac="AC1,AC2">Create Triggers Infrastructure
        <subtask id="1.1">Create convex/triggers.ts</subtask>
        <subtask id="1.2">Register enrollment completion trigger</subtask>
        <subtask id="1.3">Create convex/_customFunctions.ts</subtask>
      </task>
      <task id="2" ac="AC3">Update lessonProgress.ts
        <subtask id="2.1">Update imports</subtask>
        <subtask id="2.2">Remove inline certificate logic</subtask>
      </task>
      <task id="3" ac="AC4,AC5,AC6">Testing &amp; Validation
        <subtask id="3.1">Run unit tests</subtask>
        <subtask id="3.2">Manual integration testing</subtask>
        <subtask id="3.3">Verify no regressions</subtask>
      </task>
      <task id="4" ac="AC7">Code Review &amp; Documentation
        <subtask id="4.1">Self-review checklist</subtask>
        <subtask id="4.2">Request peer code review</subtask>
        <subtask id="4.3">Update story status</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">Create convex/triggers.ts file with enrollment trigger registration
      - Trigger fires when enrollment.completedAt is set (100% completion)
      - Trigger handles certificate generation scheduling
      - All certificate orchestration logic moved from recalculateProgress</criterion>
    <criterion id="AC2">Create convex/_customFunctions.ts with custom mutation wrapper
      - Exports mutation wrapped with triggers support
      - Uses customMutation and customCtx from convex-helpers
      - Properly imports and applies triggers.wrapDB</criterion>
    <criterion id="AC3">Update convex/lessonProgress.ts to use custom mutations
      - Import mutation from ./_customFunctions instead of ./_generated/server
      - Keep query import from standard server
      - Remove 27 lines of inline certificate logic (lines 143-170)
      - Add comment referencing triggers.ts</criterion>
    <criterion id="AC4">Certificate generation still works automatically
      - Student completes all lessons → certificate generated
      - Trigger executes in same transaction
      - Identical behavior to current implementation</criterion>
    <criterion id="AC5">All existing tests pass
      - Run yarn test → all tests green
      - No regressions in lessonProgress.test.ts
      - No breaking changes</criterion>
    <criterion id="AC6">No user-facing changes
      - Zero UI changes
      - Identical behavior before and after
      - Same performance characteristics</criterion>
    <criterion id="AC7">Code follows convex-helpers best practices
      - Follows triggers README documentation
      - Proper TypeScript types
      - Clear comments and documentation</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/tech-spec-epic-101.md"
           title="Technical Specification: Lesson Progress Tracking System"
           section="Workflows and Sequencing">
        Parent epic technical specification. Contains mark lesson complete flow, continue learning flow, and certificate generation trigger details. Lines 196-223 describe current inline certificate generation approach that this story refactors.
      </doc>
      <doc path="docs/ARCHITECTURE.md"
           title="Technical Architecture"
           section="Design Philosophy">
        Design principle: "Separation of Concerns - Clear boundaries between presentation, business logic, and data" (line 13). This refactoring aligns with this core architectural principle by separating certificate generation from progress calculation logic.
      </doc>
      <doc path="docs/PRD.md"
           title="Product Requirements Document"
           section="F6: Certificate Generation">
        Certificate generation functional requirements (lines 758-801). Certificate must be generated automatically at 100% completion with specific required fields. This refactoring maintains all PRD requirements while improving implementation.
      </doc>
      <doc path="docs/TESTING-STRATEGY.md"
           title="Testing Strategy"
           section="Unit Testing">
        Project uses Vitest for unit testing Convex functions. Tests located in convex/__test__/. Testing pattern: use convex-test library for mocking Convex context. All mutations and queries should have corresponding unit tests.
      </doc>
      <doc path="convex/lessonProgress.ts"
           title="Lesson Progress Implementation"
           section="recalculateProgress mutation">
        Current implementation to refactor. Lines 144-169 contain certificate generation logic that should move to triggers. This includes fetching course/user/instructor data and scheduling certificate generation via ctx.scheduler.runAfter().
      </doc>
    </docs>

    <code>
      <artifact path="convex/lessonProgress.ts"
                kind="convex-mutation"
                symbol="recalculateProgress"
                lines="84-174"
                reason="Contains the 27 lines of inline certificate logic (lines 144-169) that need to be removed and replaced with trigger-based approach. This is the primary refactoring target."/>
      <artifact path="convex/lessonProgress.ts"
                kind="convex-mutation"
                symbol="markComplete"
                lines="15-74"
                reason="Calls recalculateProgress (line 68). After refactoring, triggers will fire when ctx.db.patch updates enrollment.completedAt. Import statement (line 4) needs update to use custom mutation wrapper."/>
      <artifact path="convex/certificates.ts"
                kind="convex-mutation"
                symbol="generate"
                lines="30-55"
                reason="Certificate generation function that gets scheduled by trigger. API signature (lines 31-38) must match the scheduler call in new trigger. This file does NOT change, but trigger must call it correctly."/>
      <artifact path="convex/schema.ts"
                kind="schema-definition"
                symbol="enrollments"
                lines="137-174"
                reason="Enrollments table definition. Trigger will watch for changes to completedAt field. Index by_user_course enables efficient enrollment lookups. No schema changes needed."/>
      <artifact path="convex/__test__/lessonProgress.test.ts"
                kind="unit-test"
                symbol="all tests"
                reason="Existing test suite that must continue to pass after refactoring. Tests use convex-test library. Triggers execute automatically in test environment, so tests should pass unchanged."/>
      <artifact path="package.json"
                kind="dependency-manifest"
                lines="64"
                reason="convex-helpers@0.1.104 already installed (line 64). No new dependencies needed. This is a critical validation that the refactoring has zero external dependency changes."/>
    </code>

    <dependencies>
      <node>
        <package name="convex" version="^1.28.0">Convex serverless backend - provides mutation/query primitives and database</package>
        <package name="convex-helpers" version="0.1.104">Convex helper utilities - provides Triggers class and customMutation wrapper (ALREADY INSTALLED)</package>
        <package name="typescript" version="^5.9.2">TypeScript for type safety across Convex functions</package>
        <package name="vitest" version="^4.0.3">Testing framework for Convex unit tests</package>
        <package name="convex-test" version="^0.0.38">Convex testing utilities for mocking ctx in tests</package>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="breaking-changes">ZERO breaking changes allowed. All existing mutations must continue to work identically. Identical behavior before and after refactoring.</constraint>
    <constraint type="backward-compatibility">All existing code that calls lessonProgress.markComplete or lessonProgress.recalculateProgress must work unchanged. No API signature changes.</constraint>
    <constraint type="testing-coverage">All existing tests in convex/__test__/lessonProgress.test.ts must pass without modification. No test failures allowed.</constraint>
    <constraint type="performance">No performance degradation. Triggers execute in same transaction as ctx.db.patch, so same execution time. No additional database queries.</constraint>
    <constraint type="architecture">Follow Separation of Concerns principle (ARCHITECTURE.md line 13). Certificate generation logic must be completely separated from progress calculation logic.</constraint>
    <constraint type="convex-helpers-pattern">Follow convex-helpers triggers documentation exactly. Use Triggers class, customMutation wrapper, and customCtx with triggers.wrapDB pattern.</constraint>
    <constraint type="file-changes">Exactly 3 file operations: CREATE convex/triggers.ts, CREATE convex/_customFunctions.ts, MODIFY convex/lessonProgress.ts. No other files should change.</constraint>
  </constraints>

  <interfaces>
    <interface name="certificates.generate"
               kind="convex-mutation"
               signature="mutation({ args: { userId: Id&lt;'users'&gt;, userName: string, courseId: Id&lt;'courses'&gt;, courseName: string, instructorId: Id&lt;'users'&gt;, instructorName: string, templateId: string }, handler: async (ctx, args) => Id&lt;'certificates'&gt; })"
               path="convex/certificates.ts:30-55">
      Certificate generation mutation called by trigger. Must be invoked via ctx.scheduler.runAfter(0, api.certificates.generate, args). Args must match exactly: userId (ID), userName (string), courseId (ID), courseName (string), instructorId (ID), instructorName (string), templateId (string). Returns certificate ID.
    </interface>
    <interface name="Triggers.register"
               kind="convex-helpers-api"
               signature="triggers.register(tableName: string, handler: (ctx, change) => Promise&lt;void&gt;)"
               path="node_modules/convex-helpers/server/triggers.ts">
      Registers a trigger handler for a table. Change object provides: operation ('insert'|'patch'|'replace'|'delete'), id (document ID), oldDoc (pre-change), newDoc (post-change). For enrollment completion: check change.operation === 'patch' AND change.newDoc?.completedAt AND !change.oldDoc?.completedAt.
    </interface>
    <interface name="customMutation"
               kind="convex-helpers-api"
               signature="customMutation(baseMutation, ...customCtx)"
               path="node_modules/convex-helpers/server/customFunctions.ts">
      Wraps standard Convex mutation with custom context. Usage: customMutation(rawMutation, customCtx(triggers.wrapDB)). Returns wrapped mutation that can be used as drop-in replacement for standard mutation import.
    </interface>
  </interfaces>

  <tests>
    <standards>
      Project uses Vitest for Convex backend unit testing. Tests located in convex/__test__/ directory. Test files follow pattern: [module].test.ts. Use convex-test library to create mock Convex context (convexTest). All mutations and queries should have unit tests covering: success cases, error cases, edge cases, and authorization checks. Run tests with: yarn test. Coverage reports with: yarn test:coverage.
    </standards>
    <locations>
      <location>convex/__test__/*.test.ts</location>
      <location>convex/__test__/lessonProgress.test.ts (primary test file for this story)</location>
    </locations>
    <ideas>
      <idea ac="AC1,AC2">Unit test: Verify trigger registers correctly on 'enrollments' table. Mock enrollment patch with completedAt field. Assert certificate generation scheduled.</idea>
      <idea ac="AC3">Unit test: Import verification test. Assert mutation imported from _customFunctions, not _generated/server. TypeScript compilation confirms correct imports.</idea>
      <idea ac="AC4">Integration test: Complete all lessons in test course. Assert enrollment.completedAt is set. Assert certificate record created. Verify certificate.verificationCode is valid.</idea>
      <idea ac="AC5">Regression test: Run existing lessonProgress.test.ts suite. Assert all tests pass without modification. No test failures, no test changes needed.</idea>
      <idea ac="AC6">Manual test: Mark lessons complete in UI. Verify progress bar updates. Verify certificate appears in dashboard. Verify download works. Compare behavior to baseline.</idea>
      <idea ac="AC7">Code review: Lint check (yarn lint). TypeScript check (yarn typescript). Pattern review: Triggers.register follows convex-helpers README examples. Comments are clear.</idea>
    </ideas>
  </tests>
</story-context>
