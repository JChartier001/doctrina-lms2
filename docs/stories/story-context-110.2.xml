<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>110</epicId>
    <storyId>2</storyId>
    <title>Add Comprehensive Test Coverage for Core Convex Functions</title>
    <status>Draft</status>
    <generatedAt>2025-11-07</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/story-110.2.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>have comprehensive test coverage for all core Convex backend functions</iWant>
    <soThat>we can confidently deploy changes without breaking existing functionality</soThat>
    <tasks>
      <task id="1" ac="AC1">Critical Financial Code
        <subtask id="1.1">Create purchases.test.ts (~20 tests)</subtask>
        <subtask id="1.2">Create payments.test.ts (~20 tests)</subtask>
        <subtask id="1.3">Create enrollments.test.ts (~20 tests)</subtask>
      </task>
      <task id="2" ac="AC2">Core Course Creation
        <subtask id="2.1">Create courses.test.ts (~30 tests)</subtask>
        <subtask id="2.2">Create courseModules.test.ts (~25 tests)</subtask>
        <subtask id="2.3">Create lessons.test.ts (~25 tests)</subtask>
      </task>
      <task id="3" ac="AC4">User Management
        <subtask id="3.1">Create users.test.ts (~30 tests)</subtask>
      </task>
      <task id="4" ac="AC5,AC6">Coverage Validation
        <subtask id="4.1">Run coverage reports</subtask>
        <subtask id="4.2">Validate all tests pass</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">Critical financial code has 100% test coverage
      - purchases.ts: create, list, refund logic
      - payments.ts: payment flows
      - stripe.ts: webhook handling
      - All edge cases covered</criterion>
    <criterion id="AC2">Course creation flow has 100% coverage
      - courses.ts: CRUD operations, all functions tested
      - courseModules.ts: module management, all functions tested
      - lessons.ts: lesson management, all functions tested
      - Authorization tests for all mutations</criterion>
    <criterion id="AC3">Enrollment and access control 100% covered
      - enrollments.ts: create, list, access verification
      - Authorization edge cases
      - Progress tracking integration
      - All functions tested</criterion>
    <criterion id="AC4">User management 100% covered
      - users.ts: CRUD, Clerk sync, all queries tested
      - Role-based permissions
      - External ID lookups
      - All edge cases</criterion>
    <criterion id="AC5">All secondary features 100% covered
      - favorites.ts, liveSessions.ts, notifications.ts
      - recommendations.ts, resources.ts, search.ts
      - analytics.ts
      - All functions tested</criterion>
    <criterion id="AC6">Coverage metrics at 100%
      - All Convex files: 100% coverage
      - Overall project: 100% coverage target
      - Coverage report validates</criterion>
    <criterion id="AC7">All tests pass
      - 100% pass rate
      - No flaky tests
      - ~190+ total tests
      - TypeScript compilation successful</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/TESTING-STRATEGY.md"
           title="Testing Strategy"
           section="Priority-Based Testing">
        Testing philosophy and coverage priorities. Critical code (payments, access control) requires 100% coverage. Core features target 85%, UI features 70%. For this story: ALL Convex backend files must reach 100% coverage - no exceptions.
      </doc>
      <doc path="docs/ARCHITECTURE.md"
           title="Technical Architecture"
           section="Convex Mutations and Queries">
        Convex function patterns (lines 185-234). Shows mutation structure with authentication checks, query patterns with indexes, error handling. All test files must follow these established patterns.
      </doc>
    </docs>

    <code>
      <artifact path="convex/__test__/lessonProgress.test.ts"
                kind="unit-test-reference"
                symbol="all tests"
                reason="REFERENCE IMPLEMENTATION. Perfect test structure to copy: uses convexTest(schema), beforeEach setup, describe blocks per function, comprehensive edge cases. Has 25 tests with 100% coverage. Use this as template for all new test files."/>
      <artifact path="convex/__test__/certificates.test.ts"
                kind="unit-test-reference"
                symbol="all tests"
                reason="REFERENCE IMPLEMENTATION. Shows how to test CRUD operations, idempotency, error handling. Has 15 tests with 100% coverage. Good pattern for courses.test.ts."/>
      <artifact path="convex/__test__/triggers.test.ts"
                kind="unit-test-reference"
                symbol="all tests"
                reason="REFERENCE IMPLEMENTATION. Shows how to test complex logic with extracted functions for testability. Has 7 tests with 100% coverage including operation filtering."/>
      <artifact path="convex/purchases.ts"
                kind="convex-mutations-queries"
                symbol="all functions"
                reason="CRITICAL - NEEDS TESTS. Handles money/refunds. Must have 100% coverage. Test: create purchase, list purchases, refund eligibility, access control (only user's own purchases)."/>
      <artifact path="convex/payments.ts"
                kind="convex-mutations-queries"
                symbol="all functions"
                reason="CRITICAL - NEEDS TESTS. Payment processing flows. Must have 100% coverage. Test: payment creation, confirmation, error handling, Stripe integration."/>
      <artifact path="convex/enrollments.ts"
                kind="convex-mutations-queries"
                symbol="all functions"
                reason="CRITICAL - NEEDS TESTS. Course access control. Must have 100% coverage. Test: enrollment creation, getMyEnrollments, access verification, progress tracking integration."/>
      <artifact path="convex/courses.ts"
                kind="convex-mutations-queries"
                symbol="all functions"
                reason="CORE - NEEDS TESTS. Course CRUD operations. Must have 100% coverage. Test: create (with instructor auth), get, list, update, delete, authorization (instructor ownership)."/>
      <artifact path="convex/courseModules.ts"
                kind="convex-mutations-queries"
                symbol="all functions"
                reason="CORE - NEEDS TESTS. Module management. Must have 100% coverage. Test: create module, update, delete, reorder, link to course."/>
      <artifact path="convex/lessons.ts"
                kind="convex-mutations-queries"
                symbol="all functions"
                reason="CORE - NEEDS TESTS. Lesson management. Must have 100% coverage. Test: create lesson, update, delete, reorder, lesson types (video/quiz/text)."/>
      <artifact path="convex/users.ts"
                kind="convex-mutations-queries"
                symbol="all functions"
                reason="CORE - NEEDS TESTS. User management and Clerk sync. Must have 100% coverage. Test: user creation, getById, getByExternalId, getByEmail, role checks."/>
      <artifact path="convex/schema.ts"
                kind="schema-definition"
                symbol="all tables"
                reason="Schema definitions for all tables. Use in beforeEach() to set up test data. Reference for understanding table structure and indexes."/>
    </code>

    <dependencies>
      <node>
        <package name="vitest" version="4.0.8">Testing framework - already installed and configured</package>
        <package name="convex-test" version="^0.0.38">Convex testing utilities for mocking context - already installed</package>
        <package name="@vitest/coverage-v8" version="4.0.8">Coverage reporting - already installed</package>
        <package name="convex" version="^1.28.2">Convex backend</package>
        <package name="typescript" version="^5.9.3">TypeScript for type safety in tests</package>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="100-percent-coverage">ALL Convex backend files must achieve 100% test coverage. No exceptions. This includes: branches, functions, lines, and statements. Use coverage report to verify: yarn test:coverage.</constraint>
    <constraint type="test-pattern-consistency">Follow exact pattern from lessonProgress.test.ts: convexTest(schema), beforeEach setup, describe blocks per function, it blocks per scenario, expect assertions. Maintain consistency across all test files.</constraint>
    <constraint type="critical-code-first">Test in priority order: Critical (purchases, payments, enrollments) → Core (courses, modules, lessons, users) → Secondary (favorites, notifications, etc.). Ensure critical code reaches 100% before moving to next priority.</constraint>
    <constraint type="authorization-testing">Every mutation that checks ownership or permissions MUST have authorization tests: test valid user succeeds, test invalid user throws error. No authorization code untested.</constraint>
    <constraint type="edge-case-coverage">Test all edge cases: null/undefined inputs, missing records, invalid IDs, duplicate operations, empty arrays, boundary conditions. 100% coverage means testing everything.</constraint>
    <constraint type="test-isolation">Each test must be fully isolated with fresh data in beforeEach(). No test should depend on another test's data. Use convexTest(schema) to get clean database for each test file.</constraint>
    <constraint type="no-flaky-tests">Tests must be deterministic. No random data, no timing dependencies, no external API calls. Mock any external dependencies. 100% pass rate required on every run.</constraint>
  </constraints>

  <interfaces>
    <interface name="convexTest"
               kind="testing-utility"
               signature="convexTest(schema) => TestConvex"
               path="node_modules/convex-test">
      Main testing utility from convex-test library. Initialize with schema to get test environment. Returns object with: .run(async ctx => {...}), .mutation(api.x.y, args), .query(api.x.y, args), .withIdentity({subject: 'user-id'}) for auth. Use in beforeEach() to set up fresh test environment.
    </interface>
    <interface name="Testing Pattern"
               kind="test-structure"
               signature="describe() => it() => expect()"
               path="convex/__test__/lessonProgress.test.ts">
      Standard Vitest test structure. describe('ModuleName', () => { describe('functionName()', () => { it('does something', async () => { expect(result).toBe(expected); }); }); });
    </interface>
  </interfaces>

  <tests>
    <standards>
      Use Vitest testing framework with convex-test library. Target: 100% coverage across ALL Convex backend files. Test pattern: describe() blocks for each module/function, it() for each scenario, expect() assertions. Initialize test environment with convexTest(schema), use beforeEach() for setup, withIdentity() for auth. Reference: convex/__test__/lessonProgress.test.ts (25 tests, 100% coverage). All tests must be deterministic, isolated, and pass 100% of the time.
    </standards>
    <locations>
      <location>convex/__test__/*.test.ts (create ~11 new test files)</location>
      <location>convex/__test__/lessonProgress.test.ts (reference pattern)</location>
      <location>convex/__test__/certificates.test.ts (reference pattern)</location>
      <location>convex/__test__/triggers.test.ts (reference pattern)</location>
    </locations>
    <ideas>
      <idea ac="AC1">purchases.test.ts: Test create purchase, list by user, refund eligibility (30-day window, completion %), purchase status. Test authorization: only user's own purchases visible.</idea>
      <idea ac="AC1">enrollments.test.ts: Test enrollment creation after purchase, getMyEnrollments returns user's courses, access verification (enrolled vs not), progress percentage tracking, completedAt field.</idea>
      <idea ac="AC2">courses.test.ts: Test create with instructor auth, get by ID, list all, update fields, delete. Test authorization: instructor owns course, non-instructor cannot create.</idea>
      <idea ac="AC2">courseModules.test.ts: Test create module for course, update module, delete module, reorder modules. Test that modules link correctly to course.</idea>
      <idea ac="AC2">lessons.test.ts: Test create lesson for module, update, delete, reorder. Test lesson types (video, quiz, text). Test linking to module.</idea>
      <idea ac="AC4">users.test.ts: Test user creation (Clerk sync), getById, getByExternalId, getByEmail queries. Test role checks (isInstructor, isAdmin). Test user update.</idea>
      <idea ac="AC6,AC7">Coverage validation: Run yarn test:coverage, verify all Convex files show 100% in report. Run yarn test, verify ~190+ tests pass with 0 failures.</idea>
    </ideas>
  </tests>
</story-context>
